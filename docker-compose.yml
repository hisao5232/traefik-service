services:
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--providers.docker=true"
      - "--providers.file.filename=/etc/traefik/dynamic_conf.toml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--certificatesresolvers.lets-encrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.lets-encrypt.acme.storage=/acme.json"
      - "--certificatesresolvers.lets-encrypt.acme.httpChallenge.entryPoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/traefik.toml:/etc/traefik/traefik.toml"
      - "./traefik/dynamic_conf.toml:/etc/traefik/dynamic_conf.toml"
      - "./traefik/acme.json:/acme.json"

    labels:
      - "traefik.enable=true"

      # ===== Traefik Dashboard を traefik.example.com で公開 =====
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=lets-encrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      
      # Basic 認証（middleware）
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_BASIC_AUTH}"

    restart: always

  flask:
    build: ./flask
    container_name: flask-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask.rule=Host(`todo-flask.${DOMAIN}`)"
      - "traefik.http.routers.flask.entrypoints=websecure"
      - "traefik.http.routers.flask.tls.certresolver=lets-encrypt"
      - "traefik.http.services.flask.loadbalancer.server.port=5000"
    restart: always

  economic-news:
    build: ./economic-news/streamlit
    container_name: economic-news-streamlit
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.streamlit.rule=Host(`stock-streamlit.${DOMAIN}`) && PathPrefix(`/`)"
      - "traefik.http.routers.streamlit.entrypoints=websecure"
      - "traefik.http.routers.streamlit.tls.certresolver=lets-encrypt"
      - "traefik.http.services.streamlit.loadbalancer.server.port=8501"
    restart: always

  mail-webhook:
    build: ./mail-webhook
    container_name: mail-webhook-service
    environment:
      - DISCORD_WEBHOOK=${DISCORD_WEBHOOK}
      - RESEND_API_KEY=${RESEND_API_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail-webhook.rule=Host(`resend-mail.${DOMAIN}`)"
      - "traefik.http.routers.mail-webhook.entrypoints=websecure"
      - "traefik.http.routers.mail-webhook.tls.certresolver=lets-encrypt"
      - "traefik.http.services.mail-webhook.loadbalancer.server.port=3000"
    restart: always

  db:
    # 公式のPostgreSQLイメージを使用
    image: postgres:16-alpine
    
    # .envファイルから環境変数を読み込み、データベースの設定を行う
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      
    # データを永続化するためのボリュームを設定
    # コンテナが削除されてもデータはホストマシン上に残り、次回起動時に再利用されます
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      
    # データベースに外部からアクセスできるようにポートを公開
    # ホスト側:コンテナ側 の形式。DB_PORTは.envから読み込まれる。
    ports:
      - "${DB_PORT}:5432"
      
    # コンテナが予期せず停止した場合に自動的に再起動する設定
    restart: unless-stopped

    healthcheck: # DBが起動してからスクレイパーを起動するためのヘルスチェック
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  scraper:
    build:
      context: ./economic-news/scraper
    # scraperコンテナからDBコンテナにアクセスするために、DB_HOSTをサービス名 'db' に設定
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      DB_HOST: db # ★重要: Dockerネットワーク内のホスト名
      DB_PORT: 5432
    # DBコンテナが完全に起動するまで待機
    depends_on:
      db:
        condition: service_healthy # DBがヘルスチェックをパスしてから起動
  stock-news-api:
    build:
      context: ./economic-news/api-server # 適切なディレクトリを指定してください
    container_name: stock-news-api-service
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      DB_HOST: db
      DB_PORT: 5432
    depends_on:
      db:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stock-api.rule=Host(`stock-news-api.${DOMAIN}`)"
      - "traefik.http.routers.stock-api.entrypoints=websecure"
      - "traefik.http.routers.stock-api.tls.certresolver=lets-encrypt"
      - "traefik.http.services.stock-api.loadbalancer.server.port=8000"
    restart: always
    
# ホストマシンにデータを保存するためのボリュームを定義
volumes:
  postgres_data: